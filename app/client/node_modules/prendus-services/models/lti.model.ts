import {FirebaseService} from '../services/firebase.service.ts';
import {UtilitiesService} from '../services/utilities.service.ts';

const dataPath = 'ltiKeysAndSecrets';

const createAndSaveSecretIfNotCreated = async (key: string): Promise<string> => {
    try {
        const secret: string = await getSecret(key);
        const path: string = `${dataPath}/${key}`;
        await FirebaseService.set(path, secret);

        return secret;
    }
    catch(error) {
        throw error;
    }

    async function getSecret(key: string): Promise<string> {
        const existingSecret: string = await getByKey(key);

        if (!existingSecret) {
            return UtilitiesService.createUUID();
        }
        else {
            return existingSecret;
        }
    }
};

const removeByKey = async (key: string): Promise<void> => {
    try {
        await FirebaseService.remove(`${dataPath}/${key}`);
    }
    catch(error) {
        throw error;
    }
};

const getByKey = async (key: string): Promise<string> => {
    try {
        const path: string = `${dataPath}/${key}`;
        const secret: string = await FirebaseService.get(path);
        return secret;
    }
    catch(error) {
        throw error;
    }
};

export const LTIModel = {
    createAndSaveSecretIfNotCreated,
    getByKey,
    removeByKey
};
